---
- name: Build and deploy Travel Booking Platform (TBP) to Kubernetes
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - { file: vault.yml, optional: true }
    - vars.yml

  tasks:
    - name: Ensure required Ansible collections are present (informational)
      ansible.builtin.debug:
        msg: "Ensure you installed 'community.docker' and 'kubernetes.core' collections. See README."

    - name: Log in to Docker Hub
      community.docker.docker_login:
        username: "{{ dockerhub_user }}"
        password: "{{ dockerhub_password }}"

    - name: Build and push backend Docker image
      community.docker.docker_image:
        build:
          path: "{{ backend_build_path }}"
        name: "{{ dockerhub_user }}/tbp-backend"
        tag: "{{ backend_tag }}"
        push: true

    - name: Build and push frontend Docker image
      community.docker.docker_image:
        build:
          path: "{{ frontend_build_path }}"
        name: "{{ dockerhub_user }}/tbp-frontend"
        tag: "{{ frontend_tag }}"
        push: true

    - name: Apply Kubernetes manifests from the `kubernetes/` directory
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        src: "{{ k8s_manifests_path }}"

    - name: Restart backend deployment to pick up new image
      ansible.builtin.command:
        cmd: kubectl rollout restart deployment/backend -n tbp
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Restart frontend deployment to pick up new image
      ansible.builtin.command:
        cmd: kubectl rollout restart deployment/frontend -n tbp
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Wait for backend deployment to complete rollout
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Deployment
        namespace: tbp
        name: backend
      register: backend_deploy

    - name: Ensure backend pods are ready
      kubernetes.core.k8s_wait:
        kubeconfig: "{{ kubeconfig }}"
        kind: Deployment
        namespace: tbp
        name: backend
        wait_timeout: 300

    - name: Ensure frontend pods are ready
      kubernetes.core.k8s_wait:
        kubeconfig: "{{ kubeconfig }}"
        kind: Deployment
        namespace: tbp
        name: frontend
        wait_timeout: 180

    - name: Show services
      ansible.builtin.command:
        cmd: kubectl get svc -n tbp
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      register: svc_output

    - name: Print services output
      ansible.builtin.debug:
        var: svc_output.stdout_lines
